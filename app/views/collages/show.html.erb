<%= render :partial => 'shared/second_nav', :locals => { :nav_id => 'collage-logo',
  :url => collages_path,
  :right_search => 'collages/nav_search' } %>

<div id="tooltip" class="tipsy tipsy-s">
<div class="tipsy-arrow tipsy-arrow-s"></div>
<div class="tipsy-inner">
Your annotation will start here. Please click another word to set the end point.
<a href="#" id="cancel-annotation">cancel</a>
</div>
</div>

<div id="collage">
	<hgroup class="description">
		<h2 class="collage-id" id="collage-<%= @collage.id %>"><%= @collage.name %></h2>
		<aside class="toolbar">
			<ul>
				<li><a href="#" class="link-share">Share</a></li>
  				<% if current_user -%>
				<li>
    				<% form_tag(spawn_copy_collage_path(@collage)) do %>
					<a class="link-copy">Copy</a>
    				<% end %>
				</li>
				<li><%= link_to "Bookmark This Collage", bookmark_item_path("item_collage"), :class => "link-bookmark bookmark-action" %></li>
  				<% end -%>
				<li><a href="#" class="link-print">Print</a></li>
			</ul>
		</aside>
		<aside class="buttons">
			<ul>
				<li class="btn-li">
					<a href="#" class="btn-a"><span>TOOLS</span></a>
					<div class="popup tools-popup">
						<ul>
							<li>
								<strong>FULL TEXT</strong>
								<a href="#" id="full_text"><strong>SHOW</strong></a>
								<div class="cl">&nbsp;</div>
							</li>
							<li>
								<strong>ANNOTATIONS</strong>
								<a href="#" id="hide_show_annotations"><strong>SHOW</strong></a>
								<div class="cl">&nbsp;</div>
							</li>
						</ul>
						<h5>LAYERS</h5>
						<ul id="layers">
   							<% @collage.layers.each do |layer| %>
							<li data-id="l<%= layer.id %>" data-name="<%= layer.name %>" data-hex="<%= cycle('ffcd00', 'ff999a', 'bdec68') %>">
								<strong><%= layer.name %></strong>
								<a href="#" class="hide_show shown"><strong>HIDE</strong></a>
								<a href="#" class="link-o unhighlighted">HIGHLIGHT</a>
								<div class="cl">&nbsp;</div>
							</li>
   							<% end -%>
							<li>
								<strong>UNLAYERED</strong>
								<a href="#" id="hide_show_unlayered" class="shown"><strong>HIDE</strong></a>
								<div class="cl">&nbsp;</div>
							</li>
						</ul>
					</div>
				</li>
				<% if current_user && @collage.users.include?(current_user) -%>
				<li class="btn-li">
					<%= link_to "EDIT", '#', :class => "btn-a", :id => "edit-show" %>
				</li>
				<% end -%>
			</ul>
		</aside>
		<div class="cl">&nbsp;</div>
	</hgroup>
	<div class="details">
		<div class="tags">
			<ul>
   				<% @collage.tags.each do |tag| %>
				<li><%= link_to tag.name, collage_tag_path(CGI.escape(tag.name)) %></li>
   				<% end %><br />
			</ul>
		</div>
		<h5>
			<%= @collage.created_at.to_s(:simpledatetime) %> by <%= raw @collage.creators.collect { |u| link_to(u.login, user_path(u)) }.join(',') %>
			<a href="#" id="collage-stats" title="test"><strong>COLLAGE STATS</strong></a>
			<div class="popup" id="collage-stats-popup">
				<%= render :partial => 'collage_meta' %>
			</div>
		</h5>
		<% if @collage.description.length > 100 -%>
			<p id="description_less">
			<%= Collage.format_content(@collage.description[1..100]) %>... <a href="#" class="link-more">MORE</a>
			</p>
			<p id="description_more">
			<%= Collage.format_content(@collage.description) %> <a href="#" class="link-less">LESS</a>
			</p>
			<% if current_user && @collage.users.include?(current_user) -%>
			<%= link_to "EDIT", edit_collage_path(@collage), :class => "edit-action" %>
			<% end -%>
		<% else -%>
			<p id="description">
				<%= Collage.format_content(@collage.description) %>
				<% if current_user && @collage.users.include?(current_user) -%>
				<%= link_to "EDIT", edit_collage_path(@collage), :class => "edit-action" %>
				<% end -%>
			</p>
		<% end -%>
	</div>

<% if ! session[:just_born].blank?
    # This is a new collage, make sure we don't hide non-annotated text because it'll be confusing.
    session[:just_born] = nil %>
    <div class="info_block just_born">
      <h1 class="yellow_title_med">Collage created!</h1>
      You've created a new collage. We're showing all text, regardless of whether or not you had un-annotated text hidden before.
    </div>
<% end -%> 

<% 
  active_layers = []
  inactive_layers = []
  active_ids = []
  inactive_ids = []
  layer_cookies = cookies['active-layer-ids'].to_s.split(',').collect{|l| ".l#{l}"}
  @collage.layers.each do |l|
    if layer_cookies.include?(".l#{l.id}")
      active_layers << ".l#{l.id}"
      active_ids << l.id
    else
      inactive_layers << ".l#{l.id}"
      inactive_ids << l.id
    end
  end
%>

<div class="ajax-error" id="ajax-error-<%= @collage.id %>" style="display: none;"></div>

<% if false -%>
<% if ! cookies['hide-non-annotated-text'].blank? && session[:just_born].blank? %>
  <style type="text/css">
    tt{
      display: none;
    }
  </style>
<% end %>

  <style type="text/css">
    <% unless active_layers.blank? %>
      <%= active_layers.join(',') %>{
      display: none;
    }
  <% end %>
  <% unless inactive_layers.blank? %>
    <%= inactive_layers.join(',') %>{
      display: inline-block;
  }
  <% end %>
  </style>
  <% end -%>

	<article>
		<%= raw @collage.annotatable_content %>
	</article>
	<% cache("collage-annotatable-content-#{@collage.id}") do %>
	<% end -%>
</div>
  
 
<script type="text/javascript">
var is_owner = <%= current_user && @collage.can_edit? ? 1 : 0 %>;
</script>
<div id="annotation-form"></div>
