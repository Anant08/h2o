<%= render :partial => 'shared/second_nav', :locals => { :nav_id => 'collage-logo',
  :url => collages_path,
  :right_search => 'collages/nav_search' } %>

<div id="tooltip" class="tipsy tipsy-s">
<div class="tipsy-arrow tipsy-arrow-s"></div> <div class="tipsy-inner">
Your annotation will start here. Please click another word to set the end point.
<a href="#" id="cancel-annotation">cancel</a>
</div>
</div>

<div id="collage" class="singleitem" data-itemid="<%= @collage.id %>">
  <div id="fixed_header">
	<hgroup class="description">
		<h2 class="collage-id"><%= @collage.name %></h2>
		<aside class="toolbar">
			<ul>
				<li class="requires_logged_in">
    			<% form_tag(spawn_copy_collage_path(@collage)) do %>
					<a class="link-copy">Copy</a>
    			<% end %>
				</li>
				<li class="requires_logged_in">
          <%= link_to "Bookmark This Collage", bookmark_item_path("item_collage"), :class => "link-bookmark bookmark-action" %>
        </li>
				<li id="print-container">
          <a href="#" class="link-print">
            <span>Print</span>
          </a>
        </li>
			</ul>
		</aside>
		<aside class="buttons">
			<ul>
				<li class="btn-li" id="autosave"></li>
        <li class="btn-li afterload">
          <a href="#" class="btn-a" id="fonts">
            <span>Aa</span>
          </a>
					<div class="popup font-size-popup">
            <select id="font-size">
              <option value="11">small</option>
              <option value="14">medium</option>
              <option value="17">large</option>
              <option value="20">extra-large</option>
            </select>
          </div>
        </li>
				<li class="btn-li afterload">
					<a href="#" class="btn-a" id="tools">
            <span>TOOLS</span>
          </a>
					<div class="popup tools-popup">
						<ul>
							<li>
								<strong>FULL TEXT</strong>
								<a href="#" id="full_text"><strong>SHOW</strong></a>
								<div class="cl">&nbsp;</div>
							</li>
							<li>
								<strong>AUTHOR'S EDITS</strong>
								<a href="#" id="author_edits"><strong>REVERT</strong></a>
								<div class="cl">&nbsp;</div>
							</li>
							<li>
								<strong>ANNOTATIONS</strong>
								<a href="#" id="show_annotations" <%= raw 'class="inactive"' if @collage.annotations.inject(0) { |s, a| s + a.annotation_word_count } == 0 %>><strong>SHOW</strong></a>
								<a href="#" id="hide_annotations" <%= raw 'class="inactive"' if @collage.annotations.inject(0) { |s, a| s + a.annotation_word_count } == 0 %>><strong>HIDE</strong></a>
								<div class="cl">&nbsp;</div>
							</li>
						</ul>
						<h5>LAYERS</h5>
						<ul id="layers">
   					  <% @collage.layers.each do |layer| %>
							<li data-id="l<%= layer.id %>" data-name="<%= layer.name %>" data-hex="<%= cycle('ffcc00', '99ccff', '99cc33', 'ff9999', 'b2c1d0', 'ff9933', 'cc99cc') %>">
								<strong><%= layer.name %></strong>
								<a href="#" class="hide_show shown"><strong>HIDE</strong></a>
								<a href="#" class="link-o unhighlighted">HIGHLIGHT</a>
								<div class="cl">&nbsp;</div>
							</li>
   						<% end -%>
							<li>
								<strong id="unlayered">UNLAYERED</strong>
								<a href="#" id="show_unlayered"><strong>SHOW</strong></a>
								<a href="#" id="hide_unlayered"><strong>HIDE</strong></a>
								<div class="cl">&nbsp;</div>
							</li>
						</ul>
					</div>
				</li>
				<li class="btn-li requires_edit">
					<%= link_to "EDIT", '#', :class => "btn-a", :id => "edit-show" %>
				</li>
			</ul>
		</aside>
		<div class="cl">&nbsp;</div>
	</hgroup>
	<div class="details">
		<% cache("collage-#{@collage.id}-tags") do %>
		<div class="tags">
			<ul>
   				<% @collage.tags.each do |tag| %>
				<li><%= link_to tag.name, collage_tag_path(CGI.escape(tag.name)) %></li>
   				<% end %>
			</ul>
		</div>
		<% end -%>
		<h5>
			<%= @collage.created_at.to_s(:simpledatetime) %> by <%= raw @collage.creators.collect { |u| link_to(u.login, user_path(u)) }.join(',') %>
			<a href="#" id="collage-stats" title="test"><strong>COLLAGE STATS</strong></a>
			<div class="popup" id="collage-stats-popup">
				<%= render :partial => 'collage_meta' %>
			</div>
		</h5>
		<% if @collage.description.length > 100 -%>
			<div id="description_less">
			<%= Collage.format_content(@collage.description[0..100]) %>... <a href="#" class="link-more">MORE</a>
			</div>
			<div id="description_more">
			<%= Collage.format_content(@collage.description) %> <a href="#" class="link-less">LESS</a>
			</div>
			<%= link_to "EDIT", edit_collage_path(@collage), :class => "edit-action requires_edit" %>
		<% else -%>
			<div id="description">
				<%= Collage.format_content(@collage.description) %>
				<%= link_to "EDIT", edit_collage_path(@collage), :class => "edit-action requires_edit" %>
			</div>
		<% end -%>
	</div>
  </div> <!-- end fixed_test -->

	<div class="ajax-error" id="ajax-error-<%= @collage.id %>" style="display: none;"></div>
	<% cache("collage-#{@collage.id}-annotatable-content") do %>
	<article>
		<%= raw @collage.annotatable_content %>
	</article>
	<% end -%>
</div>
  
 
<script type="text/javascript">
var editability_path = "<%= access_level_collage_path(@collage) %>"; 
var last_data = <%= raw @collage.readable_state || '{}' %>;
var original_data = <%= raw @collage.readable_state || '{}' %>;
var annotations = <%= raw @collage.annotations.to_json(:include => [:layers], :except => [:annotation, :annotated_content], :methods => [:formatted_annotation_content]) %>;
</script>
<div id="annotation-form"></div>
